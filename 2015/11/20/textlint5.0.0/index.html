<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

    <title>
        
        textlint 5.0.0で非同期処理に対応、kuromoji.jsで校正、テキストの統計処理 | Web Scratch
        
    </title>
    <meta name="description" content="textlint 5.0.0をリリースしました。非同期対応のためAPIを変更したのがメインの理由です。">
    
    <meta name="keywords" content="textlint,kuromoji.js" />
    
    <meta name="author" content="azu">
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144"
          href="/public/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/public/favicon.ico">

    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed/">
    <!-- CSS -->
    <link rel="stylesheet" href="/public/css/main.css">
    <!-- JavaScript -->
    <!-- Open graph tags -->
<meta property="og:title" content="textlint 5.0.0で非同期処理に対応、kuromoji.jsで校正、テキストの統計処理">
<meta property="og:type" content="article">
<meta property="og:url" content="http://efcl.info/2015/11/20/textlint5.0.0/">
<meta property="og:image" content="http://efcl.info">

<meta property="og:description" content="textlint 5.0.0をリリースしました。非同期対応のためAPIを変更したのがメインの理由です。">
<meta property="og:site_name" content="Web Scratch">




<meta property="article:published_time" content="2015-11-20T22:09:00+09:00">
<meta property="article:author" content="https://www.facebook.com/">

<meta property="og:see_also" content="http://efcl.info/2016/03/15/textlint--fix/">

<meta property="og:see_also" content="http://efcl.info/2016/03/06/ast-first-step/">

<meta property="og:see_also" content="http://efcl.info/2016/02/29/uruu_sushi/">





<meta property="article:section" content="javascript">





<meta property="article:tag" content="textlint">

<meta property="article:tag" content="kuromoji.js">


    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-2184335-8', 'auto');
    ga('send', 'pageview');
</script>
    <script>
var blog_categories = [
{
    "title" : "greasemonkey",
    "count" : 61
},{
    "title" : "ニコニコ動画",
    "count" : 16
},{
    "title" : "小説電子化",
    "count" : 3
},{
    "title" : "vista",
    "count" : 12
},{
    "title" : "firefox",
    "count" : 56
},{
    "title" : "その他",
    "count" : 13
},{
    "title" : "webサービス",
    "count" : 22
},{
    "title" : "software",
    "count" : 58
},{
    "title" : "雑記",
    "count" : 29
},{
    "title" : "まとめ",
    "count" : 11
},{
    "title" : "zaurus",
    "count" : 3
},{
    "title" : "ハードウェア",
    "count" : 8
},{
    "title" : "アドオン",
    "count" : 31
},{
    "title" : "wordpress",
    "count" : 6
},{
    "title" : "javascript",
    "count" : 149
},{
    "title" : "インストール設定",
    "count" : 12
},{
    "title" : "iphone",
    "count" : 10
},{
    "title" : "loox u",
    "count" : 1
},{
    "title" : "tombloo",
    "count" : 3
},{
    "title" : "イベント",
    "count" : 74
},{
    "title" : "userchome.js",
    "count" : 8
},{
    "title" : "jetpack",
    "count" : 7
},{
    "title" : "onenote",
    "count" : 2
},{
    "title" : "nilscript",
    "count" : 4
},{
    "title" : "keysnail",
    "count" : 3
},{
    "title" : "ios",
    "count" : 15
},{
    "title" : "shell",
    "count" : 3
},{
    "title" : "r言語",
    "count" : 2
},{
    "title" : "node.js",
    "count" : 3
},{
    "title" : "mac",
    "count" : 2
},{
    "title" : "github",
    "count" : 9
},{
    "title" : "jekyll",
    "count" : 1
},{
    "title" : "golang",
    "count" : 1
},{
    "title" : "web",
    "count" : 1
},{
    "title" : "スライド",
    "count" : 1
},{
    "title" : "ie",
    "count" : 1
},{
    "title" : "書籍",
    "count" : 2
}
];
    blog_categories = blog_categories.filter(function(categoryObject){
        return !/^\d+$/.test(categoryObject.title);
    });
</script>
</head>


<body class="layout-reverse theme-base-0d">
<a href="https://github.com/efcl/efcl.github.io" class="github-ribbon">
    <img style="position: fixed; z-index:100; top: 0; right: 0; border: 0;"
         src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67"
         alt="Fork me on GitHub"
         data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"></a>

<header>
    <div class="site-header">
    <img src="/public/img/reimu-right.png" class="header-logo">

    <h1 class="site-title">
        <a href="/">
            Web Scratch
        </a>
    </h1>
    <p class="lead">ブラウザ/JavaScript等についてのブログ</p>

</div>
</header>
<aside>
    <div class="sidebar">
    <div class="container">
        <div class="profile">
            <a href="/about/" title="About"><img src="/public/img/azu.png" alt="Profile"></a>

            <h2><a href="/about/" title="About">azu</a></h2>
        </div>
        <div class="social">
            <a class="twitter" href="http://twitter.com/azu_re" title="Twitter">
                <img src="/public/svg/twitter.svg" alt="twitter" width="32" height="32"/>
            </a>
            <a class="github" href="https://github.com/azu" title="GitHub">
                <img src="/public/svg/github.svg" alt="GitHub" width="32" height="32"/>
            </a>
            <a class="rss" href="/feed/" title="RSS Feed">
                <img src="/public/svg/feed.svg" alt="RSS" width="32" height="32"/>
            </a>
        </div>
        <nav class="sidebar-nav">
            <div class="search">
                <form class="search-box" method="get" action="https://www.google.co.jp/search">
                    <label for="search-box-label">検索:</label>
                    <input type="hidden" name="q" value="site:efcl.info">
                    <input id="search-box-label" type="search" name="q">
                    <input type="submit" value="search">
                </form>
            </div>
            <div class="recent">
    <h3 class="recent-posts-list-title">
        <a href="/">最近の投稿</a>
    </h3>
    <ul class="recent-posts">
        
        <li>
            <a href="/2016/03/15/textlint--fix/">
                textlint 6.0リリース。--fixでの自動修正に対応
            </a>
        </li>
        
        <li>
            <a href="/2016/03/06/ast-first-step/">
                JavaScript ASTを始める最初の一歩
            </a>
        </li>
        
        <li>
            <a href="/2016/02/29/uruu_sushi/">
                #uruu_sushi アウトラインメモ
            </a>
        </li>
        
        <li>
            <a href="/2016/02/24/textlint-online-demo/">
                textlintの公式サイト(オンラインデモ)を作りました
            </a>
        </li>
        
    </ul>
</div>
            <div class="recent">
    <h3 class="categories-list-title"><a href="/categories">カテゴリ一覧</a></h3>

    <div class="categories-list" id="js-categories-list">

    </div>
    <script>
        (function () {
            var categoriesList = window.blog_categories;
            var appendPoint = document.getElementById("js-categories-list");
            // big ... small
            var sortedCategories = categoriesList.sort(function (a, b) {
                return a.count < b.count ? 1 : -1;
            });
            var ulTag = document.createElement("ul");
            var displayCount = sortedCategories.length < 3 ? sortedCategories.length : 3;
            for (var i = 0; i < displayCount; i++) {
                var category = sortedCategories[i];
                var liTag = document.createElement("li");
                var aTag = document.createElement("a");
                aTag.href = "/categories#" + category.title;
                aTag.textContent = category.title;
                var spanTag = document.createElement("span");
                spanTag.appendChild(document.createTextNode("[" + category.count + "]"));
                liTag.appendChild(aTag);
                liTag.appendChild(spanTag);
                ulTag.appendChild(liTag);
            }
            var lastLiTag = document.createElement("li");
            var lastATag = document.createElement("a");
            lastATag.href = "/categories";
            lastATag.textContent = "その他のタグ…";
            lastLiTag.appendChild(lastATag);
            ulTag.appendChild(lastATag);
            appendPoint.appendChild(ulTag);
        })();
    </script>
</div>
        </nav>
    </div>
</div>

</aside>
<article>
    <div class="content container">
        <div class="post" id="js-post-url" data-post-url="/2015/11/20/textlint5.0.0/">
    <h1 class="post-title">textlint 5.0.0で非同期処理に対応、kuromoji.jsで校正、テキストの統計処理</h1>

    <div class="pre-post-toolbar">
        <span class="post-date">2015年11月20日</span>
        <a class="btn edit-on-github" href="https://github.com/efcl/efcl.github.io/edit/develop/_posts/2015/2015-11-19-textlint5.0.0.md"><span class="edito-on-github-label"></span>Edit on GitHub</a>

    </div>
    <div class="post-content">
        <p><a href="https://github.com/textlint/textlint" title="textlint">textlint</a> 5.0.0をリリースしました。
非同期対応のためAPIを変更したのがメインの理由です。</p>

<ul>
<li><a href="https://github.com/textlint/textlint/releases/tag/5.0.0" title="Release 5.0.0: Async support · textlint/textlint">Release 5.0.0: Async support · textlint/textlint</a></li>
</ul>

<p>textlint自体については以下の記事で紹介しています。</p>

<ul>
<li><a href="http://efcl.info/2015/09/10/introduce-textlint/" title="textlintで日本語の文章をチェックする | Web Scratch">textlintで日本語の文章をチェックする | Web Scratch</a></li>
</ul>

<p>前回は<a href="http://efcl.info/2015/10/18/textlint-4.0/" title="校正ツール textlint 4.0リリース | Web Scratch">4.0リリース</a>の時に書いたので、4.0から5.0での変更点に紹介していきます。</p>

<ul>
<li><a href="https://github.com/textlint/textlint/compare/4.0.0...5.0.0" title="Comparing 4.0.0...5.0.0 · textlint/textlint">Comparing 4.0.0...5.0.0 · textlint/textlint</a></li>
</ul>

<h2 id="変更点">変更点</h2>

<h3 id="breaking-change">Breaking Change</h3>

<p>大きな変更点として全てのLint APIが非同期処理となりました。
そのため、以下のメソッドはそれぞれPromiseを返すようになっています。</p>

<p>textlintツール利用者には影響なくて、textlintをモジュールとして使ってる人のみに影響します。</p>

<ul>
<li><code>TextLintCore#LintFile</code></li>
<li><code>TextLintCore#LintText</code></li>
<li><code>TextLintEngine#executeOnFiles</code></li>
<li><code>TextLintEngine#executeOnText</code></li>
<li><code>cli#execute</code></li>
</ul>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">textlint</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TextLintCore</span><span class="p">();</span>
<span class="nx">textlint</span><span class="p">.</span><span class="nx">lintMarkdown</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">result</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// result.messages</span>
<span class="p">});</span>
</code></pre></div>
<h3 id="新しい機能">新しい機能</h3>

<p><strong>Warning</strong> <a href="https://github.com/textlint/textlint/issues/44" title="#44">#44</a></p>

<p><a href="https://github.com/textlint/textlint/releases/tag/4.1.0" title="4.1.0">4.1.0</a>でルールをエラーではなく警告として出すことが出来るようになりました。</p>

<p>以下のように<code>severity</code>オプションを設定することで、LintにかかるものがあってもexitStatusが0として終わったり、formatterで警告として出してくるようになります。</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="p">{</span>
  <span class="s2">&quot;rules&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;no-todo&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;severity&quot;</span> <span class="o">:</span> <span class="s2">&quot;warning&quot;</span>
     <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>Processor Plugin</strong> <a href="https://github.com/textlint/textlint/issues/37" title="#37">#37</a></p>

<p><a href="https://github.com/textlint/textlint/releases/tag/4.3.0" title="4.3.0">4.3.0</a>でProcessor Pluginをサポートしました。Processor Pluginはプラグインで任意の拡張子に対応出来るような仕組みのことです。</p>

<p>textlint本体のMarkdown対応などもProcessor Pluginとして実装されています。</p>

<ul>
<li><a href="https://github.com/textlint/textlint-plugin-text">textlint/textlint-plugin-text</a> built-in</li>
<li><a href="https://github.com/textlint/textlint-plugin-markdown">textlint/textlint-plugin-markdown</a> built-in</li>
<li><a href="https://github.com/textlint/textlint-plugin-html" title="textlint/textlint-plugin-html">textlint/textlint-plugin-html</a> optional</li>
</ul>

<p>自分で任意のフォーマットに対するパーサを書いて<a href="https://github.com/textlint/textlint/blob/master/docs/txtnode.md" title="TxtNode">TxtNode</a>からなるASTを作れば、textlintはそれを扱えるようになっています。</p>

<p>実際に作ると<a href="https://github.com/textlint/textlint/blob/master/docs/txtnode.md#type" title="type">type</a>がPlugin間で固定されていたりするので、その辺はIssueなどを立てて頂けると対応できます。</p>

<p>textlint本体からは特定のフォーマットに依存するような処理は外部モジュールやプラグイン、ルールとして実装してあります。</p>

<p><a href="http://efcl.info/wp-content/uploads/2015/11/textlint.png"><img src="http://efcl.info/wp-content/uploads/2015/11/textlint.png" alt="textlint plugin"></a></p>

<p>そのため<a href="https://github.com/textlint/textlint/blob/master/docs/txtnode.md" title="TxtNode">TxtNode</a>や<a href="https://github.com/textlint/textlint/blob/master/typing/textlint.d.ts" title="TextLintMessage">TextLintMessage</a>といったインタフェースだけを決めて、具体的な処理は外に移譲しています。</p>

<p>この辺を上手く使ってテキストの統計データを出せる<a href="https://github.com/azu/textstat" title="textstat">textstat</a>を作ったりしています。</p>

<p><strong>ルール毎のパフォーマンス表示</strong></p>

<p><a href="https://github.com/textlint/textlint/releases/tag/4.6.0" title="4.6.0">4.6.0</a>で<code>TIMING=1</code>という環境変数を設定して実行すると、それぞれのルールにかかってる処理時間をだせるようになりました。
(ESLintと全く同じ実装なので、非同期のルールに対応できてない…)</p>

<ul>
<li><a href="https://github.com/textlint/textlint/blob/master/docs/create-rules.md#rule-performance" title="Rule Performance">Rule Performance</a></li>
</ul>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ TIMING=1 textlint README.md
Rule                            | Time (ms) | Relative
:-------------------------------|----------:|--------:
spellcheck-tech-word            |   124.277 |    70.7%
prh                             |    18.419 |    10.5%
no-mix-dearu-desumasu           |    13.965 |     7.9%
max-ten                         |    13.246 |     7.5%
no-start-duplicated-conjunction |     5.911 |     3.4%
</code></pre></div>
<p><strong><code>context#getFilePath</code>の追加</strong></p>

<p><a href="https://github.com/textlint/textlint/releases/tag/4.7.0" title="4.7.0">4.7.0</a>で<code>context#getFilePath</code>というAPIを追加しました。
これは処理しているファイルパスを返します。(標準入力を対象した場合はnullを返します)</p>

<p>以下のようにしてファイルパスを取得することができます。</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kr">import</span> <span class="nx">fs</span> <span class="nx">from</span> <span class="s2">&quot;fs&quot;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">fileSize</span> <span class="nx">from</span> <span class="s2">&quot;filesize&quot;</span><span class="p">;</span>
<span class="kr">export</span> <span class="k">default</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="p">{</span> <span class="nx">Syntax</span><span class="p">,</span> <span class="nx">getFilePath</span><span class="p">,</span> <span class="nx">report</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">context</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="p">[</span><span class="nx">Syntax</span><span class="p">.</span><span class="nx">Document</span><span class="p">](</span><span class="nx">node</span><span class="p">){</span>
            <span class="c1">// ファイルパスを取得</span>
            <span class="kd">let</span> <span class="nx">filePath</span> <span class="o">=</span> <span class="nx">getFilePath</span><span class="p">();</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">stats</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">statSync</span><span class="p">(</span><span class="nx">filePath</span><span class="p">);</span>
                <span class="c1">// ファイルサイズを取る Kb</span>
                <span class="kd">var</span> <span class="nx">fileSizeInBytes</span> <span class="o">=</span> <span class="nx">stats</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">];</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e_e</span><span class="p">)</span> <span class="p">{</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>ルール内で非同期処理が可能に</strong></p>

<ul>
<li><a href="https://github.com/textlint/textlint/issues/74" title="Rule: async support · Issue #74 · textlint/textlint">Rule: async support · Issue #74 · textlint/textlint</a></li>
</ul>

<p>今まではルール内で同期的な処理しか書けませんでしたが、
5.0.0からはpromiseオブジェクトを返すとそのpromiseが解決できるまで結果を待つようになっています。</p>

<p>以下のようにPromiseを返すことで、非同期処理をルール中に書くことができます。
(同期処理は今まででと何も変わらない)</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kr">export</span> <span class="k">default</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="p">[</span><span class="nx">Syntax</span><span class="p">.</span><span class="nx">Str</span><span class="p">](</span><span class="nx">node</span><span class="p">){</span>
            <span class="c1">// textlint wait for resolved the promise.</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="c1">// async task</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>ルール中で返したPromiseオブジェクトが全てresolveすると処理が終わったと判断して、結果を出力するようになっています。</p>

<p>一つでもRejectedとなったPromiseがある場合に失敗したと判断してエラーを出します。(<code>Promise.all</code>をしているだけです)</p>

<h3 id="非同期の使い道">非同期の使い道</h3>

<p>ほぼ同じ機構を持つESLintが非同期対応してないことからも分かりますが、普通にLintする場合は非同期APIがなくても問題ないです。</p>

<p>textlintはESLintと違って自然言語を扱うことが多いです。
自然言語の場合は形態素解析をするなど重たい処理があったり、他の言語で書かれた外部のプロセスに処理を投げられると便利です。</p>

<p>そのため、textlintからREST APIを通信してLintができるようにするための変更です。</p>

<blockquote class="twitter-tweet" lang="en"><p lang="ja" dir="ltr">textlintのruleでYahooの校正API叩くのって悪手かなー。個人で使う分には問題無さそうだけども。</p>&mdash; もろみざとけいた (@kta_moromii) <a href="https://twitter.com/kta_moromii/status/661575606216232960">November 3, 2015</a></blockquote>

<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>追記: できたそうです =&gt; <a href="http://qiita.com/KeitaMoromizato/items/9b77c8202f2e5f49c471" title="CircleCI - 継続的インテグレーションで実現するWebメディアの執筆フロー - Qiita">CircleCI - 継続的インテグレーションで実現するWebメディアの執筆フロー - Qiita</a></p>

<p>また、<a href="https://github.com/takuyaa/kuromoji.js" title="kuromoji.js">kuromoji.js</a>のように辞書の非同期ロードが必要なものへ対応したかったのも理由の一つです。</p>

<p>実際に非同期処理を使ったルールとして<a href="https://github.com/azu/textlint-rule-no-doubled-joshi" title="azu/textlint-rule-no-doubled-joshi">azu/textlint-rule-no-doubled-joshi</a>があります。</p>

<p><a href="https://github.com/azu/textlint-rule-no-doubled-joshi" title="azu/textlint-rule-no-doubled-joshi">textlint-rule-no-doubled-joshi</a>は1センテンス中に同じ助詞が連続して使われてないかをチェックするルールです。</p>

<blockquote>
<p>材料不足で代替素材で製品を作った</p>
</blockquote>

<p>を例にすると&quot;で&quot;という助詞が連続している部分を検出できます。</p>

<p>RedPenの<em>DoubledJoshi</em>と大体同じですが、デフォルトでは&quot;の&quot;、&quot;を&quot;は例外的に除外したり緩めの設定です。
オプションで<code>{&quot;strict&quot;:true}</code>とすれば少し厳しく判定するようになっています。</p>

<ul>
<li><a href="http://atl.recruit-tech.co.jp/blog/3694/" title="RedPen v1.4 のリリース | Advanced Technology Lab">RedPen v1.4 のリリース | Advanced Technology Lab</a></li>
</ul>

<p>実際に使ってみると案外気づけなかった部分が分かります。
Lint結果に従いリファクタリングしていくとセンテンスは短くなる傾向があります。</p>

<ul>
<li><a href="https://github.com/azu/JavaScript-Plugin-Architecture/pull/89" title="textlint: 二重助詞の利用をチェックするルールを追加 by azu · Pull Request #89 · azu/JavaScript-Plugin-Architecture">textlint: 二重助詞の利用をチェックするルールを追加 by azu · Pull Request #89 · azu/JavaScript-Plugin-Architecture</a></li>
</ul>

<p>1センテンスを短く分解する手法については以下のスライドが参考になります。</p>

<ul>
<li><a href="http://www.slideshare.net/takahi-i/ss-13429892" title="作文入門">作文入門</a></li>
</ul>

<p><a href="https://github.com/efcl/efcl.github.io/pull/120" title="textlint 5.0.0について by azu · Pull Request #120 · efcl/efcl.github.io">この記事もno-doubled-joshiでチェック</a>しながら書かれています。
ただ、適当に書くと色々指摘されるので、気軽に書きたいブログとかだとやかましいかもしれないですね。</p>

<h3 id="ルールの仕組み">ルールの仕組み</h3>

<p>このルールは<a href="https://github.com/azu/sentence-splitter" title="azu/sentence-splitter">sentence-splitter</a>を使ってパラグラフをセンテンスに分解し、<a href="https://github.com/takuyaa/kuromoji.js" title="kuromoji.js">kuromoji.js</a>を使ってセンテンスを形態素解析して品詞をチェックすることでチェックしています。</p>

<p>kuromoji.jsを直接使うと同時に辞書を読み込もうとして、読み込みが終わらない問題を作りやすいので、<a href="https://github.com/azu/kuromojin" title="azu/kuromojin">azu/kuromojin</a>というkuromoji.jsのPromiseラッパを作りました。</p>

<p>同時に初期化(辞書を読み込み)しても大丈夫なようにロックと、一度読み込んだら次からキャッシュを使うようにするシンプルなラッパーです。</p>

<p><a href="https://github.com/azu/textlint-rule-no-doubled-joshi" title="azu/textlint-rule-no-doubled-joshi">textlint-rule-no-doubled-joshi</a>では以下のように、テキストをセンテンスに分解して、センテンスをさらにkuromoji.jsで形態素解析しています。</p>

<p>そうして取れた<code>token</code>の品詞を見ていき、助詞が連続してないかをチェックするような仕組みになっています。</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kr">import</span> <span class="p">{</span><span class="nx">getTokenizer</span><span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;kuromojin&quot;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">splitSentences</span><span class="p">,</span> <span class="p">{</span><span class="nx">Syntax</span> <span class="nx">as</span> <span class="nx">SentenceSyntax</span><span class="p">}</span> <span class="nx">from</span> <span class="s2">&quot;sentence-splitter&quot;</span><span class="p">;</span>


<span class="kr">export</span> <span class="k">default</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="p">{</span><span class="nx">Syntax</span><span class="p">,</span> <span class="nx">report</span><span class="p">,</span> <span class="nx">getSource</span><span class="p">,</span> <span class="nx">RuleError</span><span class="p">}</span> <span class="o">=</span> <span class="nx">context</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="c1">// TODO: 本来はParagraphでやるべき</span>
        <span class="c1">// text `code` text のようなものが対象にできてない</span>
        <span class="p">[</span><span class="nx">Syntax</span><span class="p">.</span><span class="nx">Str</span><span class="p">](</span><span class="nx">node</span><span class="p">){</span>
            <span class="kd">let</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">getSource</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
            <span class="c1">// テキストをセンテンスに分解</span>
            <span class="kd">let</span> <span class="nx">sentences</span> <span class="o">=</span> <span class="nx">splitSentences</span><span class="p">(</span><span class="nx">text</span><span class="p">).</span><span class="nx">filter</span><span class="p">(</span><span class="nx">node</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">node</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">SentenceSyntax</span><span class="p">.</span><span class="nx">Sentence</span><span class="p">;</span>
            <span class="p">});</span>
            <span class="c1">// 非同期でkuromoji.jsの初期化&amp;ロック&amp;キャッシュ</span>
            <span class="k">return</span> <span class="nx">getTokenizer</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">tokenizer</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="kr">const</span> <span class="nx">checkSentence</span> <span class="o">=</span> <span class="p">(</span><span class="nx">sentence</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                  <span class="c1">// センテンス毎のtokensを取り出してチェック処理</span>
                  <span class="kd">let</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">tokenizer</span><span class="p">.</span><span class="nx">tokenizeForSentence</span><span class="p">(</span><span class="nx">sentence</span><span class="p">.</span><span class="nx">raw</span><span class="p">);</span>
                <span class="p">};</span>
                <span class="nx">sentences</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">checkSentence</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>
</code></pre></div>
<p>ルール間で初期化コストを共有できるので、<a href="https://github.com/azu/kuromojin" title="azu/kuromojin">azu/kuromojin</a>経由で使っておくと楽なのかもしれません(もっといい方法がありそうならIssueとか立てて下さい)</p>

<hr>

<h2 id="その他">その他</h2>

<p>Atomプラグインである<a href="https://github.com/1000ch/linter-textlint" title="linter-textlint">linter-textlint</a>もtextlint 5.0.0に対応しています。</p>

<p>Atomで書きながらチェック出来るのでかなり便利です。</p>

<p><img src="https://monosnap.com/file/L6zYnuUAI7F2v1eShhiUeLxJ3m3KRq.png" alt="textlint-linter"></p>

<p>Windowsでの導入方法の例
(特にOS依存はないので、どの環境も普通にnpm installしてプロジェクトを開けば使えます)</p>

<ul>
<li><a href="https://github.com/KenshoFujisaki/TextlintAtom" title="KenshoFujisaki/TextlintAtom">KenshoFujisaki/TextlintAtom</a></li>
</ul>

<p>gulpから使う場合は<a href="https://github.com/textlint/gulp-textlint" title="gulp-textlint">gulp-textlint</a>などもあるので、こちらの方を利用するといい気がします。</p>

<h3 id="textstat"><a href="https://github.com/azu/textstat" title="textstat">textstat</a></h3>

<p><a href="https://github.com/azu/textstat" title="textstat">textstat</a>というtextlintの上で動くテキスト統計処理ツールも公開しています。
(Wordの文字数カウントとかそういう感じのものです)</p>

<p>基本的にルールの書き方や設定ファイルの書き方も同じですが、こちらはデフォルトで幾つかルールを持っています。
(言語が関係ないファイルサイズや行数などの統計ルール)</p>

<p>日本語向けのルールを思いつきで書いてる<a href="https://github.com/azu/textstat-plugin-ja" title="textstat-plugin-ja">textstat-plugin-ja</a>というプラグインも公開しているので、以下のような手順で使うと簡単にファイルのテキスト統計情報が出せます。</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>npm install textstat-plugin-ja textstat -g
<span class="nv">$ </span>textstat --plugin ja _posts/2015/2015-11-19-textlint5.0.0.md
┌──────────────────────┬────────────────────────────────────────────────────────────┐
│ filePath             │ _posts/2015/2015-11-19-textlint5.0.0.md                    │
├──────────────────────┼────────────────────────────────────────────────────────────┤
│ fileSize             │ 26.07 kB                                                   │
├──────────────────────┼────────────────────────────────────────────────────────────┤
│ number of characters │ <span class="m">15782</span>                                                      │
├──────────────────────┼────────────────────────────────────────────────────────────┤
│ number of Lines      │ <span class="m">322</span>                                                        │
├──────────────────────┼────────────────────────────────────────────────────────────┤
│ number of Images     │ <span class="m">2</span>                                                          │
├──────────────────────┼────────────────────────────────────────────────────────────┤
│ number of Links      │ <span class="m">43</span>                                                         │
├──────────────────────┼────────────────────────────────────────────────────────────┤
│ number of List Items │ <span class="m">18</span>                                                         │
├──────────────────────┼────────────────────────────────────────────────────────────┤
│ number of Paragraphs │ <span class="m">75</span>                                                         │
├──────────────────────┼────────────────────────────────────────────────────────────┤
│ number of sentences  │ <span class="m">172</span>                                                        │
├──────────────────────┼────────────────────────────────────────────────────────────┤
│ share of code        │ 48%                                                        │
├──────────────────────┼────────────────────────────────────────────────────────────┤
│ 文字種               │                                                            │
├──────────────────────┼────────────────────────────────────────────────────────────┤
│ ひらがな             │ 36%                                                        │
├──────────────────────┼────────────────────────────────────────────────────────────┤
│ カタカナ             │ 9%                                                         │
├──────────────────────┼────────────────────────────────────────────────────────────┤
│ 漢字                 │ 16%                                                        │
├──────────────────────┼────────────────────────────────────────────────────────────┤
│ アルファベット       │ 29%                                                        │
├──────────────────────┼────────────────────────────────────────────────────────────┤
│ 日本文の読みやすさ   │ 54.7                                                       │
├──────────────────────┼────────────────────────────────────────────────────────────┤
│                      │ 読みやすさの偏差値<span class="o">(</span>平均50、標準偏差10、高いほど読みやすい<span class="o">)</span> │
└──────────────────────┴────────────────────────────────────────────────────────────┘
</code></pre></div>
<p><a href="https://github.com/azu/textstat" title="textstat">textstat</a>も<a href="https://github.com/azu/textstat#create-rule">ルールはJavaScript</a>で簡単に書けるので、気になった部分を数値として出してみると面白いかもしれません。</p>

<h2 id="今後">今後</h2>

<p>形態素解析を使ったルールも書けるようになったので、初期にやりたかった事は大体できた気がします。</p>

<p>ルールもある程度増えてきたので、逆にどうやって使い始めればいいかみたいなドキュメントが不足してるのでその辺を追加する予定です。</p>

<ul>
<li><a href="https://github.com/textlint/textlint/wiki/Collection-of-textlint-rule" title="Collection of textlint rule · textlint/textlint Wiki">Collection of textlint rule · textlint/textlint Wiki</a></li>
</ul>

<p>日本語向けのルールばかりなので、普通にブログでオススメ設定を書くみたいのでも良さそうな気はしています。</p>

<p>以下のIssueが立っているので、「この辺が分からない」といった部分があったらコメントして下さい。</p>

<ul>
<li><a href="https://github.com/textlint/textlint/issues/91" title="Enhance document(ES6) · Issue #91 · textlint/textlint">Enhance document(ES6) · Issue #91 · textlint/textlint</a></li>
</ul>

    </div>
    <div class="post-post-toolbar">
        <a class="btn edit-on-github"
           href="https://github.com/efcl/efcl.github.io/edit/develop/_posts/2015/2015-11-19-textlint5.0.0.md"><span
                class="edit-on-github-label"></span>修正リクエストをする</a>
        <nav class="tags"
             id="js-post-tags"
             data-post-tags='["textlint","kuromoji.js"]'>
            <span>タグ:</span>
            <ul>
                
                <li><a href="/tags/?q=textlint">textlint</a></li>
                
                <li><a href="/tags/?q=kuromoji.js">kuromoji.js</a></li>
                
            </ul>
        </nav>
    </div>
    <div class="announce-area">
        <h3>お知らせ欄</h3>
        <div class="announce-text">
            <!--お知らせ-->
JavaScriptに関する最新情報は週一で<a href="http://jser.info/" title="JSer.info">JSer.info</a>を更新しています。

        </div>
        <h3>次に書くかもしれない記事候補</h3>
        <p>興味がありましたら<a href="https://github.com/efcl/efcl.github.io/labels/%E8%A8%98%E4%BA%8B%E5%80%99%E8%A3%9C" title="Issues · efcl/efcl.github.io">Issues · efcl/efcl.github.io</a>からご意見下さい</p>
        <div class="announce-text">
            <iframe src="https://azu.github.io/github-issue-widget/?owner=efcl&repo=efcl.github.io&labels=記事候補&limit=4&random"
                    allowtransparency="true" frameborder="0" scrolling="0" width="100%" height="100%"></iframe>
        </div>
    </div>
    <div class="related-articles" id="js-related-articles">
        <h3>関連記事</h3>
    </div>
</div>
<div class="zenback-embed">
    <!-- X:S ZenBackWidget --><div id="zenback-widget-loader"></div><script type="text/javascript">!function(d,i){if(!d.getElementById(i)){var r=Math.ceil((new Date()*1)*Math.random());var j=d.createElement("script");j.id=i;j.async=true;j.src="//w.zenback.jp/v1/?base_uri=http%3A//efcl.info/&nsid=89229392978401102%3A%3A89229398078677080&rand="+r;d.body.appendChild(j);}}(document,"zenback-widget-js");</script><!-- X:E ZenBackWidget -->
</div>
<div class="disqus-embed" id="js-disqus-embed">
    <button class="comment-button" id="js-comment-button">コメントを表示</button>
</div>

<script type="text/javascript" src="/public/js/tag-fetcher.js"></script>
<script type="text/javascript" src="/public/js/show-related-article.js"></script>
<script type="text/javascript" src="/public/js/show-disqus.js"></script>

    </div>
</article>
</body>
</html>
